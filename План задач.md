# План задач (MVP мебель‑ИИ)

Этот план основан на `.qoder/quests/unknown-task.md`, `RDP.md`, `дизайн.md`, `описание.md`. Отмечайте выполненное галочками. Разбито по этапам, с подзадачами и критериями приёмки.

## Легенда
- [ ] не начато  •  [~] в работе  •  [x] готово
- Все размеры — в мм. Русский язык в интерфейсе и доках. ПДн в промпты не передавать. Presigned URL TTL ≤ 15 мин.

---

## Этап 0 — Подготовка проекта
- [x] Создать каркас mono-repo в корне
  - [x] Папки: `api/`, `web/`, `integrations/`, `cad-cam/`, `shared/`, `tests/`, `docs/`
  - [x] `.gitignore`, `README.md`, `docker-compose.yml`, `pyproject.toml`
- [~] Инициализировать git-репозиторий (ветки `main`, `develop`)
- [ ] Линтеры/форматтеры
  - [x] Backend: Black, Ruff
  - [ ] Frontend: ESLint, Prettier
- [ ] CI/CD (GitHub Actions)
  - [x] Линт (Ruff/Black) на PR/Push
  - [x] Условный билд фронта (если `web` и package.json есть)
- [ ] Базовая документация
  - [ ] `CONTRIBUTING.md`, `STYLEGUIDE.md`, `docs/architecture.md`
  - [x] `docs/architecture.md`

## Этап 1 — Доменная модель и API
- [ ] Pydantic-схемы: `Order`, `ProductConfig`, `Panel`, `BOM`, `HardwareItem`, `Supplier`, `DXFJob`, `GCodeJob`, `Artifact`, `AuditLog`, `Validation`, `ValidationItem`
- [x] FastAPI каркас `api/` и REST v1 контракты (заглушки)
  - [x] Базовый `api/main.py` и `/health`
  - [x] POST `/api/v1/spec/extract`
  - [x] POST `/api/v1/hardware/select`
  - [x] POST `/api/v1/cam/dxf`
  - [x] POST `/api/v1/cam/gcode`
  - [x] POST `/api/v1/spec/validate`
  - [x] POST `/api/v1/validation/approve`
  - [x] POST `/api/v1/integrations/1c/export`
- [x] OpenAPI (Swagger) доступен и актуален
 - [ ] Диаграммы состояний CAM (docs) — Created → Processing → Completed/Failed

## Этап 2 — Хранилище и инфраструктура
- [ ] PostgreSQL 16: миграции (Alembic) для всех сущностей
- [ ] Redis 7.2: настройка очередей задач (CAM), DLQ
- [ ] Object Storage: слой абстракции для presigned URL (YC)
- [ ] Локальная разработка (опционально)
  - [x] docker-compose: `postgres`, `redis`, (опц.) `minio` для S3-совместимости
- [ ] Секреты/конфиги через env (без ПДн и ключей в репозитории)

## Этап 3 — Интеграция ИИ (текст и OCR)
- [ ] Клиенты с ретраями/таймаутами/логами
  - [ ] Yandex Vision OCR
  - [ ] YandexGPT 5.1 Pro
  - [ ] Yandex Embeddings
  - [ ] GigaChat API (fallback)
- [ ] Реализация `/api/v1/spec/extract`
  - [ ] Обработка text/image/sketch
  - [ ] Извлечение параметров + confidence
  - [ ] Логирование промптов/ответов без ПДн
- [ ] Интерактивная валидация после extract
  - [ ] `/api/v1/spec/validate` — генерация Validation/Items
  - [ ] Блок перехода до approve

## Этап 4 — Векторный слой (RAG, фурнитура)
- [ ] Схема карточки фурнитуры (`sku`, `brand`, `type`, `params`, `compat`, `url`, `version`)
- [ ] Импорт/нормализация каталогов (CSV/XLSX/JSON) + валидации
- [ ] Эмбеддинги карточек (Yandex Embeddings)
- [ ] Коллекция в YDB Vector Search (ANN) + индексы
- [ ] k-NN поиск + фильтры (материал/толщина/тип/совместимость)
- [ ] Оркестрация RAG
  - [ ] Запрос → k-NN → контекст → YandexGPT (ранжирование)
  - [ ] Аудит: источники, версии записей
- [ ] Интеграция в `/api/v1/hardware/select`

## Этап 5 — CAD/CAM (MVP)
- [ ] DXF-генерация (ezdxf 1.4.2): панели, аннотации, слойность
- [ ] FreeCAD 1.0.x Path (GRBL): генерация G-code headless
- [ ] Асинхронные CAM-задачи (Redis): статусы, повторы, ошибки
- [ ] Проверки CAM: размеры (мм), радиусы, оффсеты
- [ ] Упаковка ZIP: DXF, NC, BOM, отчёты, метаданные

## Этап 6 — Frontend (Next.js 15.5 / React 19)
- [ ] Инициализация приложения `web/` (TS)
- [ ] Экраны
  - [ ] Загрузка ТЗ/эскиза
  - [ ] Проверка параметров (Validation UI)
  - [ ] Спецификация/BOM
  - [ ] Подбор фурнитуры (RAG)
  - [ ] CAM (очередь, статусы, загрузка ZIP)
  - [ ] Интеграции 1С
- [ ] Типы/клиенты для всех API
- [ ] UI-паттерны из `дизайн.md`: bento-grid, steppers, skeletons
- [ ] Доступность (контраст ≥ 4.5:1, фокус, ARIA), горячие клавиши
- [ ] Обработка ошибок/пустых состояний, лоадеры LLM/OCR

## Этап 7 — Интеграция с 1С
- [ ] Коннектор чтения: справочники, синхронизация, конфликты
- [ ] Коннектор записи: экспорт BOM/заказов, маппинг кодов
- [ ] Контракты обмена (URI/поля/ошибки) — docs

## Этап 8 — Качество (golden set)
- [ ] Сбор 20–30 эталонных ТЗ (текст/эскизы) и эталонных ответов
- [ ] E2E сценарии: ТЗ→BOM→RAG→DXF/G-code→ZIP→1С
- [ ] Метрики качества: точность извлечения, Precision@K, доля ручной правки
- [ ] Регламент ручной валидации и приёмки

## Этап 9 — Безопасность и аудит
- [ ] Анонимизация ПДн, scrub логов, запрет ПДн в промпты
- [ ] Presigned URL TTL ≤ 15 мин; раздельные бакеты
- [ ] Аудит: промпты/ответы (без ПДн), источники RAG, доступ к файлам
- [ ] Роли: администратор, технолог, дизайнер (авторизация/права)

## Этап 10 — Наблюдаемость
- [ ] YC Cloud Logging интеграция (структурированные логи)
- [ ] Метрики: latency P50/P95, ошибки, ресурсы
- [ ] Алерты: деградация поиска, рост токенов, падение точности
- [ ] SLO/SLA: цели, пороги, дашборды, отчёты

## Этап 11 — UAT и релиз
- [ ] Сценарии UAT (полный цикл пайплайна)
- [ ] UAT чек-лист, шаблон отчёта о дефектах
- [ ] Документация для пилотов: user guide, техническая, эксплуатация

## Этап 12 — Post-MVP бэклог (не входит в приёмку MVP)
- [ ] Новые постпроцессоры: Fanuc, WoodWOP
- [ ] Расширение правил фурнитуры (совместимость, аналоги)
- [ ] Автоматический нестинг, себестоимость
- [ ] Ассистенты обучения, подсказки технологу
- [ ] Импорт проектов: К3, БАЗИС, bCAD
- [ ] Мобильная версия, офлайн, уведомления
- [ ] ERP расширения: Галактика, Парус, 1С:ERP
- [ ] Advanced: Zero Trust, tracing, anomaly detection, dark theme, глобальный поиск

---

## Поперечные требования (везде)
- [ ] Русский язык интерфейса и документации
- [ ] Единицы измерения — миллиметры (мм)
- [ ] Логирование источников RAG и версий данных
- [ ] Фиксированный стек из `RDP.md` (не менять версии без решения)
- [ ] Always-on правила из `.qoder/rules/important.md` соблюдены

## Сводные чекбоксы по API
- [ ] `/api/v1/spec/extract` — реализовано, покрыто тестами, задокументировано
- [ ] `/api/v1/spec/validate` — реализовано, блокирующая логика, UI
- [ ] `/api/v1/validation/approve` — реализовано, аудит
- [ ] `/api/v1/hardware/select` — k-NN+ранжирование, аудит источников
- [ ] `/api/v1/cam/dxf` — асинхронная задача, статусы, артефакты
- [ ] `/api/v1/cam/gcode` — асинхронная задача, статусы, артефакты
- [ ] `/api/v1/integrations/1c/export` — контракт обмена, обработка ошибок

## Приёмка MVP — Definition of Done
- [ ] Все эндпоинты v1 реализованы и покрыты автотестами
- [ ] Сквозной сценарий «ТЗ/эскиз → BOM → RAG → DXF/G-code → ZIP → 1С» работает на golden set
- [ ] P95 `/spec/extract` ≤ 5 с; CAM — асинхронно и стабильно
- [ ] Presigned ссылки и аудит источников включены по умолчанию
- [ ] Документация готова: OpenAPI, глоссарий, регламенты качества/поддержки

## Быстрые ссылки
- `.qoder/quests/unknown-task.md` — архитектура, контракты, диаграммы
- `RDP.md` — зафиксированные версии и запреты
- `дизайн.md` — UI-паттерны, wizard, bento-grid
- `описание.md` — контекст и цели
