# План задач (MVP мебель‑ИИ)

Этот план основан на `.qoder/quests/unknown-task.md`, `RDP.md`, `дизайн.md`, `описание.md`. Отмечайте выполненное галочками. Разбито по этапам, с подзадачами и критериями приёмки.

## Легенда
- [ ] не начато  •  [~] в работе  •  [x] готово
- Все размеры — в мм. Русский язык в интерфейсе и доках. ПДн в промпты не передавать. Presigned URL TTL ≤ 15 мин.

---

## Этап 0 — Подготовка проекта
- [x] Создать каркас mono-repo в корне
  - [x] Папки: `api/`, `web/`, `integrations/`, `cad-cam/`, `shared/`, `tests/`, `docs/`
  - [x] `.gitignore`, `README.md`, `docker-compose.yml`, `pyproject.toml`
- [~] Инициализировать git-репозиторий (ветки `main`, `develop`)
- [ ] Линтеры/форматтеры
  - [x] Backend: Black, Ruff
  - [ ] Frontend: ESLint, Prettier
- [ ] CI/CD (GitHub Actions)
  - [x] Линт (Ruff/Black) на PR/Push
  - [x] Условный билд фронта (если `web` и package.json есть)
- [ ] Базовая документация
  - [ ] `CONTRIBUTING.md`, `STYLEGUIDE.md`, `docs/architecture.md`
  - [x] `docs/architecture.md`

## Этап 0.5 — Дизайн и UX
- [x] Провести аудит и обновить `дизайн.md` до стандартов 2025 года

## Этап 1 — Доменная модель и API
- [x] Pydantic-схемы: `Order`, `ProductConfig`, `Panel`, `BOM`, `HardwareItem`, `Supplier`, `DXFJob`, `GCodeJob`, `Artifact`, `AuditLog`, `Validation`, `ValidationItem`
- [x] FastAPI каркас `api/` и REST v1 контракты (заглушки)
  - [x] Базовый `api/main.py` и `/health`
  - [x] POST `/api/v1/spec/extract`
  - [x] POST `/api/v1/hardware/select`
  - [x] POST `/api/v1/cam/dxf`
  - [x] POST `/api/v1/cam/gcode`
  - [x] POST `/api/v1/spec/validate`
  - [x] POST `/api/v1/validation/approve`
  - [x] POST `/api/v1/integrations/1c/export`
- [x] OpenAPI (Swagger) доступен и актуален
 - [x] Диаграммы состояний CAM (docs) — Created → Processing → Completed/Failed

## Этап 2 — Хранилище и инфраструктура
- [x] PostgreSQL 16: миграции (Alembic) для всех сущностей
- [~] Redis 7.2: настройка очередей задач (CAM), DLQ
  - [x] Очереди DXF/GCODE, DLQ — контракты и helper'ы
  - [x] Воркёр (MVP) добавлен, типовые ошибки Pylance устранены
  - [x] Запуск воркёра как сервиса и e2e смоук-тест статусов
  - [x] Генерация DXF (ezdxf) и загрузка артефакта в S3 (MinIO), presigned URL
- [x] Object Storage: слой абстракции для presigned URL (YC)
- [x] Локальная разработка (опционально)
  - [x] docker-compose: `postgres`, `redis`, (опц.) `minio` для S3-совместимости
  - Примечание: на Windows запускать `alembic upgrade` внутри контейнера `api` из-за сетевых особенностей
- [x] Секреты/конфиги через env (без ПДн и ключей в репозитории)
  - [x] `.env.example` добавлен

## Этап 3 — Интеграция ИИ (текст и OCR)
- [~] Клиенты с ретраями/таймаутами/логами
  - [x] Yandex Embeddings (POST /foundationModels/v1/textEmbedding)
  - [x] YandexGPT 5 (POST /foundationModels/v1/completion)
  - [x] Yandex Vision OCR (POST /ocr/v1/recognizeText)
  - [ ] GigaChat API (fallback)
- [x] Реализация `/api/v1/spec/extract`
  - [x] Обработка text/image/sketch
  - [x] Извлечение параметров + confidence
  - [x] Логирование промптов/ответов без ПДн
  - [x] Fallback для разработки без YC credentials
- [x] Диалоговое уточнение параметров с ИИ-технологом
  - [x] AI: Проектирование логики диалога, системного промпта и спецификации (см. docs/ai_dialogue_spec.md)
  - [x] API: Проектирование и реализация эндпоинта `/api/v1/dialogue/clarify`
  - [x] DB: Модель и хранение истории диалога для каждого заказа
  - [x] AI: Интеграция с YandexGPT в режиме диалога (системный промпт, управление историей)
  - [x] API: Реализация потоковой передачи (streaming) ответа от модели

## Этап 4 — Векторный слой (RAG, фурнитура)
- [x] Схема карточки фурнитуры (`sku`, `brand`, `type`, `params`, `compat`, `url`, `version`)
- [x] Импорт/нормализация каталогов (CSV/XLSX/JSON) + валидации
- [x] Эмбеддинги карточек (Yandex Embeddings)
- [x] Коллекция в YDB Vector Search (ANN) + индексы
- [x] k-NN поиск + фильтры (материал/толщина/тип/совместимость)
- [x] Оркестрация RAG
  - [x] Запрос → k-NN → контекст → YandexGPT (ранжирование)
  - [x] Аудит: источники, версии записей
- [x] Интеграция в `/api/v1/hardware/select`

## Этап 5 — CAD/CAM (MVP)
- [~] DXF-генерация (ezdxf 1.4.2): панели, аннотации, слойность
  - [x] MVP: прямоугольник и выгрузка .dxf в Object Storage
  - [x] Расширить: слои, метаданные, единицы, аннотации
- [x] FreeCAD 1.0.x Path (GRBL): генерация G-code headless
- [ ] Асинхронные CAM-задачи (Redis): статусы, повторы, ошибки
  - [x] Статусы: Created→Processing→Completed/Failed
  - [x] Артефакт DXF привязан к задаче (artifact_id)
  - [x] Повторы/бэкофф, счётчик попыток, idempotency key
- [x] Проверки CAM: размеры (мм), радиусы, оффсеты
- [x] Упаковка ZIP: DXF, NC, BOM, отчёты, метаданные

Примечания:
- Presigned URL выдаётся с host `minio:9000` (внутрисетевой). Для скачивания с хоста подменяйте на `localhost:9000` или прокиньте reverse-proxy/настройте MINIO_SERVER_URL.

## Этап 5.5 — Публичный сайт, аутентификация и платежи
- [ ] **Требование**: Все публичные страницы, формы и уведомления должны быть полностью на русском языке.
- [ ] **Публичный сайт**:
  - [ ] Разработка Лендинга (главной страницы).
  - [ ] Разработка страницы "Тарифы".
- [ ] **Аутентификация**:
  - [ ] Реализация UI для форм регистрации, входа и восстановления пароля.
  - [ ] Реализация API-эндпоинтов и логики для управления пользователями.
- [ ] **Платежи и подписки**:
  - [ ] Выбор и интеграция платежного шлюза (например, ЮKassa, Robokassa).
  - [ ] Реализация логики управления тарифами и подписками.
- [ ] **Настройки пользователя**:
  - [ ] UI и API для раздела "Настройки", где пользователь может управлять своим профилем и паролем.

## Этап 6 — Frontend (Next.js 15.5 / React 19)
- [ ] Инициализация приложения `web/` (TS)
- [ ] Экраны
  - [ ] Загрузка ТЗ/эскиза
  - [ ] Диалог с ИИ-технологом (чат на базе Vercel AI SDK)
  - [ ] Спецификация/BOM
  - [ ] Подбор фурнитуры (RAG)
  - [ ] CAM (очередь, статусы, загрузка ZIP)
  - [ ] Интеграции 1С
- [ ] Типы/клиенты для всех API
- [ ] UI-паттерны из `дизайн.md`
- [ ] Доступность (контраст ≥ 4.5:1, фокус, ARIA), горячие клавиши
- [ ] Обработка ошибок/пустых состояний, лоадеры LLM/OCR

## Этап 7 — Интеграция с 1С
- [ ] Коннектор чтения: справочники, синхронизация, конфликты
- [ ] Коннектор записи: экспорт BOM/заказов, маппинг кодов
- [ ] Контракты обмена (URI/поля/ошибки) — docs

## Этап 8 — Качество (golden set)
- [ ] Сбор 20–30 эталонных ТЗ (текст/эскизы) и эталонных ответов
- [ ] E2E сценарии: ТЗ→BOM→RAG→DXF/G-code→ZIP→1С
- [ ] Метрики качества: точность извлечения, Precision@K, доля ручной правки
- [ ] Регламент ручной валидации и приёмки

## Этап 9 — Безопасность и аудит
- [ ] Анонимизация ПДн, scrub логов, запрет ПДн в промпты
- [ ] Presigned URL TTL ≤ 15 мин; раздельные бакеты
- [ ] Аудит: промпты/ответы (без ПДн), источники RAG, доступ к файлам
- [ ] Роли: администратор, технолог, дизайнер (авторизация/права)
- [ ] Реализовать панель администратора на базе SQLAdmin
  - [ ] Интеграция SQLAdmin в FastAPI приложение (эндпоинт /admin)
  - [ ] Настройка аутентификации для доступа только администраторам
  - [ ] Регистрация ключевых моделей (User, Order, HardwareItem) для управления

## Этап 10 — Наблюдаемость
- [ ] YC Cloud Logging интеграция (структурированные логи)
- [ ] Метрики: latency P50/P95, ошибки, ресурсы
- [ ] Алерты: деградация поиска, рост токенов, падение точности
- [ ] SLO/SLA: цели, пороги, дашборды, отчёты

## Этап 11 — UAT и релиз
- [ ] Сценарии UAT (полный цикл пайплайна)
- [ ] UAT чек-лист, шаблон отчёта о дефектах
- [ ] Документация для пилотов: user guide, техническая, эксплуатация

## Этап 12 — Post-MVP бэклог (не входит в приёмку MVP)
- [ ] Новые постпроцессоры: Fanuc, WoodWOP
- [ ] Расширение правил фурнитуры (совместимость, аналоги)
- [ ] Автоматический нестинг, себестоимость
- [ ] Ассистенты обучения, подсказки технологу
- [ ] Импорт проектов: К3, БАЗИС, bCAD
- [ ] Мобильная версия, офлайн, уведомления
- [ ] ERP расширения: Галактика, Парус, 1С:ERP
- [ ] Advanced: Zero Trust, tracing, anomaly detection, dark theme, глобальный поиск

## Этап 13 тест-кейсы фронтенда подробные и унит тесты системы полное покрытие.

---

## Поперечные требования (везде)
- [ ] Русский язык интерфейса и документации
- [ ] Единицы измерения — миллиметры (мм)
- [ ] Логирование источников RAG и версий данных
- [ ]  стек из `RDP.md` 
- [ ] Always-on правила из `.qoder/rules/important.md` соблюдены

## Сводные чекбоксы по API
- [ ] `/api/v1/spec/extract` — реализовано, покрыто тестами, задокументировано
- [ ] `/api/v1/spec/validate` — реализовано, блокирующая логика, UI
- [ ] `/api/v1/validation/approve` — реализовано, аудит
- [ ] `/api/v1/hardware/select` — k-NN+ранжирование, аудит источников
- [ ] `/api/v1/cam/dxf` — асинхронная задача, статусы, артефакты
- [ ] `/api/v1/cam/gcode` — асинхронная задача, статусы, артефакты
- [ ] `/api/v1/integrations/1c/export` — контракт обмена, обработка ошибок

## Приёмка MVP — Definition of Done
- [ ] Все эндпоинты v1 реализованы и покрыты автотестами
- [ ] Сквозной сценарий «ТЗ/эскиз → BOM → RAG → DXF/G-code → ZIP → 1С» работает на golden set
- [ ] P95 `/spec/extract` ≤ 5 с; CAM — асинхронно и стабильно
- [ ] Presigned ссылки и аудит источников включены по умолчанию
- [ ] Документация готова: OpenAPI, глоссарий, регламенты качества/поддержки

## Быстрые ссылки
- `.qoder/quests/unknown-task.md` — архитектура, контракты, диаграммы
- `RDP.md` — зафиксированные версии и запреты
- `дизайн.md` — UI-паттерны, wizard, bento-grid
- `описание.md` — контекст и цели
